name: T721 Monorepo CI

on: [push]

jobs:
    install:
        name: "[STAGE 1][@repo] install"
        runs-on: ubuntu-latest
        steps:

            #
            # Initial Stup Steps
            #

            - uses: actions/checkout@v1
            - name: "Use Node.js 12.x"
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: "Setup SSH Agent"
              uses: webfactory/ssh-agent@v0.1.1
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: "Install required tools globally (npm install -g lerna lcov-result-merger yarn)"
              run: npm install -g lerna@3.16.4 lcov-result-merger@3.1.0 yarn@1.22.4

            - name: "Recover submodules (yarn setup:submodules:clone)"
              run: yarn setup:submodules:clone

            #
            # Cache Yarn Workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @backend_migrations"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_migrations/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_migrations

            - name: "CACHE @backend_nest"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_nest/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_nest

            - name: "CACHE @backend_simulation"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_simulation/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_simulation

            - name: "CACHE @common_global"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_global/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_global

            - name: "CACHE @common_sdk"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_sdk/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_sdk

            #
            # Cache Public Modules
            #

            - name: "CACHE @public_dosojin"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_dosojin/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_dosojin/yarn.lock') }}-public_dosojin

            - name: "CACHE @public_e712"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_e712/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_e712/yarn.lock') }}-public_e712

            - name: "CACHE @public_erc2280"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_erc2280/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_erc2280/yarn.lock') }}-public_erc2280

            - name: "CACHE @public_ethvtx"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_ethvtx/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_ethvtx/yarn.lock') }}-public_ethvtx

            #
            # Cache Smart Contracts Modules
            #

            - name: "CACHE @contracts_metamarketplace"
              uses: actions/cache@v1
              with:
                  path: ./contracts/contracts_modules/metamarketplace/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/metamarketplace/package-lock.json') }}-metamarketplace

            - name: "CACHE @contracts_refract"
              uses: actions/cache@v1
              with:
                  path: ./contracts/contracts_modules/refract/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/refract/package-lock.json') }}-refract

            - name: "CACHE @contracts_t721admin"
              uses: actions/cache@v1
              with:
                  path: ./contracts/contracts_modules/t721admin/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/t721admin/package-lock.json') }}-t721admin

            - name: "CACHE @contracts_t721controller"
              uses: actions/cache@v1
              with:
                  path: ./contracts/contracts_modules/t721controller/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/t721controller/package-lock.json') }}-t721controller

            - name: "CACHE @contracts_t721token"
              uses: actions/cache@v1
              with:
                  path: ./contracts/contracts_modules/t721token/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/t721token/package-lock.json') }}-t721token

            - name: "CACHE @contracts_ticketforge"
              uses: actions/cache@v1
              with:
                  path: ./contracts/contracts_modules/ticketforge/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/ticketforge/package-lock.json') }}-ticketforge

            #
            # Run Complete install
            #

            - name: "Install all dependencies (yarn @install)"
              run: "yarn @install"

    global:
        name: "[STAGE 2][@common/global] build, lint & test"
        needs: install
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v1
            - name: "Use Node.js 12.x"
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: "Install required tools globally (npm install -g yarn)"
              run: npm install -g yarn@1.22.4

            - name: "CACHE @common/global/coverage"
              uses: actions/cache@v1
              with:
                  path: modules/@common_global/coverage
                  key: ${{ runner.os }}-global-coverage-${{ github.sha }}

            #
            # Cache Yarn Workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @common_global"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_global/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_global

            - name: "Build @ticket721sources/global (yarn build in modules/@common_global)"
              working-directory: modules/@common_global
              run: yarn build

            - name: "TSLint @ticket721sources/global (yarn lint in modules/@common_global)"
              working-directory: modules/@common_global
              run: yarn lint

            - name: "Test @ticket721sources/global (yarn test:cov in modules/@common_global)"
              working-directory: modules/@common_global
              run: yarn test:cov

    sdk:
        name: "[STAGE 2][@common/sdk] build"
        needs: install
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v1
            - name: Use Node.js 12.x
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: CACHE /node_modules
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('package-lock.json') }}-root

            - name: "Install required tools globally (npm install -g yarn)"
              run: npm install -g yarn@1.22.4

            #
            # Cache Yarn Workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @common_global"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_global/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_global

            - name: "CACHE @common_sdk"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_global/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_global

            - name: "Build @ticket721sources/global (npm run build in sources/global)"
              working-directory: modules/@common_global
              run: yarn build

            - name: "Build @ticket721sources/sdk (npm run build in sources/sdk)"
              working-directory: modules/@common_sdk
              run: yarn build

            - name: "TSLint @ticket721sources/sdk (npm run lint in sources/sdk)"
              working-directory: modules/@common_sdk
              run: yarn lint

#    server:
#        needs: install
#        runs-on: ubuntu-latest
#        steps:
#            - uses: actions/checkout@v1
#            - name: Use Node.js 12.x
#              uses: actions/setup-node@v1.2.0
#              with:
#                  node-version: 12.x
#
#            - name: Setup SSH Agent
#              uses: webfactory/ssh-agent@v0.1.1
#              with:
#                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
#
#            - name: Setup submodules (npm run setup:submodules:clone)
#              run: npm run setup:submodules:clone
#
#            - name: CACHE /modules/dosojin
#              uses: actions/cache@v1
#              with:
#                  path: ./modules/dosojin
#                  key: ${{ runner.os }}-${{ hashFiles('modules/dosojin/package-lock.json') }}-root
#
#            - name: CACHE sources/server/coverage
#              uses: actions/cache@v1
#              with:
#                  path: sources/server/coverage
#                  key: ${{ runner.os }}-server-coverage-${{ github.sha }}
#
#            - name: CACHE /node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('package-lock.json') }}-root
#
#            - name: CACHE /contracts/contracts_modules/metamarketplace/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./contracts/contracts_modules/metamarketplace/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/metamarketplace/package-lock.json') }}-metamarketplace
#
#            - name: CACHE /contracts/contracts_modules/refract/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./contracts/contracts_modules/refract/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/refract/package-lock.json') }}-refract
#
#            - name: CACHE /contracts/contracts_modules/t721controller/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./contracts/contracts_modules/t721controller/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/t721controller/package-lock.json') }}-t721controller
#
#            - name: CACHE /contracts/contracts_modules/ticketforge/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./contracts/contracts_modules/ticketforge/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/ticketforge/package-lock.json') }}-ticketforge
#
#            - name: CACHE /sources/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./sources/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('sources/package-lock.json') }}-sources
#
#            - name: CACHE /sources/global/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./sources/global/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('sources/global/package-lock.json') }}-global
#
#            - name: CACHE /sources/sdk/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./sources/sdk/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('sources/sdk/package-lock.json') }}-sdk
#
#            - name: CACHE /sources/migrations/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./sources/migrations/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('sources/migrations/package-lock.json') }}-migrations
#
#            - name: CACHE /sources/server/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./sources/server/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('sources/server/package-lock.json') }}-server
#
#            - name: Link sources (npm run link:sources)
#              run: npm run link:sources
#
#            - name: Setup portals (npm run setup:portals)
#              run: npm run setup:portals
#
#            - name: Build @ticket721sources/global (npm run build in sources/global)
#              working-directory: sources/global
#              run: npm run build
#
#            - name: Build @ticket721sources/sdk (npm run build in sources/sdk)
#              working-directory: sources/sdk
#              run: npm run build
#
#            - name: Build @ticket721sources/server @app/server
#              working-directory: sources/server
#              run: npm run build:server
#
#            - name: Run @ticket721sources/server @app/server, @lib/common unitary tests (npm run test:cov in sources/server)
#              working-directory: sources/server
#              run: npm run test:cov
#
#            - name: Format check on @ticket721sources/server
#              working-directory: sources/server
#              run: npm run format:check
#
#            - name: TSLint check on @ticket721sources/server
#              working-directory: sources/server
#              run: npm run lint
#
#            - name: Compodoc Coverage check on @ticket721sources/server
#              working-directory: sources/server
#              run: npm run doc:coverage


#    server-e2e:
#        needs: install
#        runs-on: ubuntu-latest
#        steps:
#            - uses: actions/checkout@v1
#            - name: Use Node.js 12.x
#              uses: actions/setup-node@v1.2.0
#              with:
#                  node-version: 12.x
#
#            - name: Setup SSH Agent
#              uses: webfactory/ssh-agent@v0.1.1
#              with:
#                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
#
#            - name: Install required tools globally (npm install -g truffle)
#              run: npm install -g truffle@5.1.6
#
#            - name: Setup submodules (npm run setup:submodules:clone)
#              run: npm run setup:submodules:clone
#
#            - name: CACHE /modules/dosojin
#              uses: actions/cache@v1
#              with:
#                  path: ./modules/dosojin
#                  key: ${{ runner.os }}-${{ hashFiles('modules/dosojin/package-lock.json') }}-root
#
#            - name: CACHE sources/server/coverage-server-e2e
#              uses: actions/cache@v1
#              with:
#                  path: sources/server/coverage-server-e2e
#                  key: ${{ runner.os }}-coverage-server-e2e-${{ github.sha }}
#
#            - name: CACHE /node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('package-lock.json') }}-root
#
#            - name: CACHE /contracts/contracts_modules/metamarketplace/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./contracts/contracts_modules/metamarketplace/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/metamarketplace/package-lock.json') }}-metamarketplace
#
#            - name: CACHE /contracts/contracts_modules/refract/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./contracts/contracts_modules/refract/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/refract/package-lock.json') }}-refract
#
#            - name: CACHE /contracts/contracts_modules/t721admin/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./contracts/contracts_modules/t721admin/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/t721admin/package-lock.json') }}-t721admin
#
#            - name: CACHE /contracts/contracts_modules/t721controller/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./contracts/contracts_modules/t721controller/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/t721controller/package-lock.json') }}-t721controller
#
#            - name: CACHE /contracts/contracts_modules/t721token/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./contracts/contracts_modules/t721token/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/t721token/package-lock.json') }}-t721token
#
#            - name: CACHE /contracts/contracts_modules/ticketforge/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./contracts/contracts_modules/ticketforge/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('contracts/contracts_modules/ticketforge/package-lock.json') }}-ticketforge
#
#            - name: CACHE /sources/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./sources/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('sources/package-lock.json') }}-sources
#
#            - name: CACHE /sources/global/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./sources/global/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('sources/global/package-lock.json') }}-global
#
#            - name: CACHE /sources/sdk/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./sources/sdk/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('sources/sdk/package-lock.json') }}-sdk
#
#            - name: CACHE /sources/migrations/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./sources/migrations/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('sources/migrations/package-lock.json') }}-migrations
#
#            - name: CACHE /sources/server/node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./sources/server/node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('sources/server/package-lock.json') }}-server
#
#            - name: Link sources (npm run link:sources)
#              run: npm run link:sources
#
#            - name: Setup portals (npm run setup:portals)
#              run: npm run setup:portals
#
#            - name: Build @ticket721sources/global (npm run build in sources/global)
#              working-directory: sources/global
#              run: npm run build
#
#            - name: Build @ticket721sources/sdk (npm run build in sources/sdk)
#              working-directory: sources/sdk
#              run: npm run build
#
#            - name: Run @ticket721sources/server @app/server e2e tests (npm run test:server:e2e:cov in sources/server)
#              run: sudo sysctl -w vm.max_map_count=262144 && cd sources/server && npm run test:server:e2e:cov

#    coverage:
#        needs: [global, sdk, server, server-e2e]
#        runs-on: ubuntu-latest
#        steps:
#            - uses: actions/checkout@v1
#            - name: Use Node.js 12.x
#              uses: actions/setup-node@v1.2.0
#              with:
#                  node-version: 12.x
#
#            - name: CACHE /node_modules
#              uses: actions/cache@v1
#              with:
#                  path: ./node_modules
#                  key: ${{ runner.os }}-${{ hashFiles('package-lock.json') }}-root
#
#            - name: CACHE sources/global/coverage
#              uses: actions/cache@v1
#              with:
#                  path: sources/global/coverage
#                  key: ${{ runner.os }}-global-coverage-${{ github.sha }}
#
#            - name: CACHE sources/server/coverage
#              uses: actions/cache@v1
#              with:
#                  path: sources/server/coverage
#                  key: ${{ runner.os }}-server-coverage-${{ github.sha }}
#
#            - name: CACHE sources/server/coverage-server-e2e
#              uses: actions/cache@v1
#              with:
#                  path: sources/server/coverage-server-e2e
#                  key: ${{ runner.os }}-coverage-server-e2e-${{ github.sha }}
#
#            - name: Codecov (npm run codecov:upload)
#              run: npm run codecov:upload
#              env:
#                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
#
