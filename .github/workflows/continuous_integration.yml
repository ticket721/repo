name: T721 Monorepo CI

on: [push]

jobs:

#     /$$$$  /$$$$$$    /$$   /$$$$
#    | $$_/ /$$__  $$ /$$$$  |_  $$
#    | $$  | $$  \__/|_  $$    | $$
#    | $$  |  $$$$$$   | $$    | $$
#    | $$   \____  $$  | $$    | $$
#    | $$   /$$  \ $$  | $$    | $$
#    | $$$$|  $$$$$$/ /$$$$$$ /$$$$
#    |____/ \______/ |______/|____/
#
#    @repo - install
#
#    Install all dependencies of workspace modules, public modules and contracts modules
#    Everything is stored into cache
#

    install:
        name: "[S1] [@repo] install"
        runs-on: ubuntu-latest
        steps:

            #
            # Initial Setup
            #

            - uses: actions/checkout@v1
            - name: "Use Node.js 12.x"
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: "Setup SSH Agent"
              uses: webfactory/ssh-agent@v0.1.1
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: "Install required tools globally (npm install -g lerna lcov-result-merger yarn)"
              run: npm install -g lerna@3.16.4 lcov-result-merger@3.1.0 yarn@1.22.4

            - name: "Recover submodules (yarn setup:submodules:clone)"
              run: yarn setup:submodules:clone

            #
            # Cache Yarn Workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @backend_migrations"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_migrations/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_migrations

            - name: "CACHE @backend_nest"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_nest/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_nest

            - name: "CACHE @backend_simulation"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_simulation/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_simulation

            - name: "CACHE @common_global"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_global/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_global

            - name: "CACHE @common_sdk"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_sdk/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_sdk

            - name: "CACHE @frontend_flib-react"
              uses: actions/cache@v1
              with:
                  path: ./modules/@frontend_flib-react/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-frontend_flib-react

            - name: "CACHE @frontend_core"
              uses: actions/cache@v1
              with:
                  path: ./modules/@frontend_core/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-frontend_core

            #
            # Cache Public Modules
            #

            - name: "CACHE @public_dosojin"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_dosojin/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_dosojin/yarn.lock') }}-public_dosojin

            - name: "CACHE @public_e712"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_e712/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_e712/yarn.lock') }}-public_e712

            - name: "CACHE @public_erc2280"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_erc2280/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_erc2280/yarn.lock') }}-public_erc2280

            - name: "CACHE @public_ethvtx"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_ethvtx/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_ethvtx/yarn.lock') }}-public_ethvtx

            #
            # Cache Smart Contracts Modules
            #

            - name: "CACHE @contracts_metamarketplace"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_metamarketplace/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_metamarketplace

            - name: "CACHE @contracts_refract"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_refract/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_refract

            - name: "CACHE @contracts_t721admin"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_t721admin/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_t721admin

            - name: "CACHE @contracts_t721controller"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_t721controller/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_t721controller

            - name: "CACHE @contracts_t721token"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_t721token/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_t721token

            - name: "CACHE @contracts_ticketforge"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_ticketforge/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_ticketforge

            #
            # Run Complete install
            #

            - name: "Install all dependencies (yarn @install)"
              run: "yarn @install"

#     /$$$$  /$$$$$$   /$$$$$$  /$$$$
#    | $$_/ /$$__  $$ /$$__  $$|_  $$
#    | $$  | $$  \__/|__/  \ $$  | $$
#    | $$  |  $$$$$$   /$$$$$$/  | $$
#    | $$   \____  $$ /$$____/   | $$
#    | $$   /$$  \ $$| $$        | $$
#    | $$$$|  $$$$$$/| $$$$$$$$ /$$$$
#    |____/ \______/ |________/|____/
#
#    @common_global - build, lint & test
#
#    Recovers required dependencies from cache
#    Builds sources to verify everything still transpiles properly
#    Lints sources to verify everything is formatted properly
#    Runs unitary tests to verify logic is kept
#

    global:
        name: "[S2] [@common/global] build, lint & test"
        needs: install
        runs-on: ubuntu-latest
        steps:

            #
            # Initial Setup
            #

            - uses: actions/checkout@v1
            - name: "Use Node.js 12.x"
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: "Install required tools globally (npm install -g yarn)"
              run: npm install -g yarn@1.22.4

            #
            # Cache Coverage Directory
            #

            - name: "CACHE @common/global/coverage"
              uses: actions/cache@v1
              with:
                  path: modules/@common_global/coverage
                  key: ${{ runner.os }}-common_global-coverage-${{ github.sha }}

            #
            # Cache Yarn Workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @common_global"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_global/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_global

            #
            # Build, Lint & Test @common_global
            #

            - name: "Build @ticket721sources/global (yarn build in modules/@common_global)"
              working-directory: modules/@common_global
              run: yarn build

            - name: "TSLint @ticket721sources/global (yarn lint in modules/@common_global)"
              working-directory: modules/@common_global
              run: yarn lint

            - name: "Test @ticket721sources/global (yarn test:cov in modules/@common_global)"
              working-directory: modules/@common_global
              run: yarn test:cov

#     /$$$$  /$$$$$$   /$$$$$$  /$$$$
#    | $$_/ /$$__  $$ /$$__  $$|_  $$
#    | $$  | $$  \__/|__/  \ $$  | $$
#    | $$  |  $$$$$$   /$$$$$$/  | $$
#    | $$   \____  $$ /$$____/   | $$
#    | $$   /$$  \ $$| $$        | $$
#    | $$$$|  $$$$$$/| $$$$$$$$ /$$$$
#    |____/ \______/ |________/|____/
#
#    @common_sdk - build & lint
#
#    Recovers required dependencies from cache
#    Builds sources to verify everything still transpiles properly
#    Lints sources to verify everything is formatted properly
#

    sdk:
        name: "[S2] [@common/sdk] build & lint"
        needs: install
        runs-on: ubuntu-latest
        steps:

            #
            # Initial Setup
            #

            - uses: actions/checkout@v1
            - name: "Use Node.js 12.x"
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: "Install required tools globally (npm install -g yarn)"
              run: npm install -g yarn@1.22.4

            #
            # Cache Yarn Workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @common_global"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_global/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_global

            - name: "CACHE @common_sdk"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_sdk/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_sdk

            - name: "CACHE @backend_nest"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_nest/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_nest

            #
            # Build dependencies
            #

            - name: "Build @ticket721sources/global (npm run build in sources/global)"
              working-directory: modules/@common_global
              run: yarn build

            #
            # Build, Lint & Test @common_sdk
            #

            - name: "Build @ticket721sources/sdk (npm run build in sources/sdk)"
              working-directory: modules/@common_sdk
              run: yarn build

            - name: "TSLint @ticket721sources/sdk (npm run lint in sources/sdk)"
              working-directory: modules/@common_sdk
              run: yarn lint

#     /$$$$  /$$$$$$   /$$$$$$  /$$$$
#    | $$_/ /$$__  $$ /$$__  $$|_  $$
#    | $$  | $$  \__/|__/  \ $$  | $$
#    | $$  |  $$$$$$   /$$$$$$/  | $$
#    | $$   \____  $$ /$$____/   | $$
#    | $$   /$$  \ $$| $$        | $$
#    | $$$$|  $$$$$$/| $$$$$$$$ /$$$$
#    |____/ \______/ |________/|____/
#
#    @backend_nest - build, lint, format, doc & test
#
#    Recovers required dependencies from cache
#    Builds sources to verify everything still transpiles properly
#    Lints sources to verify everything is formatted properly
#    Runs prettier norm checker to verify everything is formatted properly
#    Runs compodoc coverage reported to verify all documentation is done
#    Runs unitary tests to verify logic is kept
#

    server:
        name: "[S2] [@backend/nest] build, lint & test"
        needs: install
        runs-on: ubuntu-latest
        steps:

            #
            # Initial Setup
            #

            - uses: actions/checkout@v1
            - name: Use Node.js 12.x
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: Setup SSH Agent
              uses: webfactory/ssh-agent@v0.1.1
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: "Install required tools globally (npm install -g yarn)"
              run: npm install -g yarn@1.22.4

            - name: "Setup submodules (yarn setup:submodules:clone)"
              run: yarn setup:submodules:clone

            #
            # Cache Public Modules
            #

            - name: "CACHE @public_dosojin"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_dosojin/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_dosojin/yarn.lock') }}-public_dosojin

            - name: "CACHE @public_e712"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_e712/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_e712/yarn.lock') }}-public_e712

            #
            # Cache Coverage Directory
            #

            - name: "CACHE @backend_nest/coverage"
              uses: actions/cache@v1
              with:
                  path: modules/@backend_nest/coverage
                  key: ${{ runner.os }}-backend_nest-coverage-${{ github.sha }}

            #
            # Cache Yarn Workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @common_sdk"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_sdk/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_sdk

            - name: "CACHE @common_global"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_global/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_global

            - name: "CACHE @backend_nest"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_nest/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_nest

            #
            # Setup portals
            #

            - name: "Setup portals (yarn setup:portals)"
              run: yarn setup:portals

            #
            # Build dependencies
            #

            - name: "Build @common_global (yarn build in modules/@common_global)"
              working-directory: modules/@common_global
              run: yarn build

            - name: "Build @common_sdk (yarn build in modules/@common_sdk)"
              working-directory: modules/@common_sdk
              run: yarn build

            #
            # Build, Test, Lint, Format Check and Doc Check @backend_nest
            #

            - name: "Build @backend_nest @app/server"
              working-directory: modules/@backend_nest
              env:
                  NODE_ENV: production
              run: yarn build:server

            - name: "Build @backend_nest @app/worker"
              working-directory: modules/@backend_nest
              env:
                  NODE_ENV: production
              run: yarn build:worker

            - name: "Run @backend_nest @app/server, @app/worker, @lib/common unitary tests (yarn test:cov in modules/@backend_nest)"
              working-directory: modules/@backend_nest
              run: yarn test:cov

            - name: "Format check on @backend_nest"
              working-directory: modules/@backend_nest
              run: yarn format:check

            - name: "TSLint check on @backend_nest"
              working-directory: modules/@backend_nest
              run: yarn lint

            - name: "Compodoc Coverage check on @backend_nest"
              working-directory: modules/@backend_nest
              run: yarn doc:coverage

#     /$$$$  /$$$$$$   /$$$$$$  /$$$$
#    | $$_/ /$$__  $$ /$$__  $$|_  $$
#    | $$  | $$  \__/|__/  \ $$  | $$
#    | $$  |  $$$$$$   /$$$$$$/  | $$
#    | $$   \____  $$ /$$____/   | $$
#    | $$   /$$  \ $$| $$        | $$
#    | $$$$|  $$$$$$/| $$$$$$$$ /$$$$
#    |____/ \______/ |________/|____/
#
#    @backend_nest - test-e2e
#
#    Recovers required dependencies from cache
#    Runs e2e tests to verify components are properly working together
#

    server-e2e:
        name: "[S2] [@backend/nest] test-e2e"
        needs: install
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v1
            - name: "Use Node.js 12.x"
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: "Setup SSH Agent"
              uses: webfactory/ssh-agent@v0.1.1
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: "Install required tools globally (npm install -g yarn)"
              run: npm install -g yarn@1.22.4

            - name: "Setup submodules (yarn setup:submodules:clone)"
              run: yarn setup:submodules:clone

            #
            # Cache Smart Contracts Modules
            #

            - name: "CACHE @contracts_metamarketplace"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_metamarketplace/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_metamarketplace

            - name: "CACHE @contracts_refract"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_refract/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_refract

            - name: "CACHE @contracts_t721admin"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_t721admin/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_t721admin

            - name: "CACHE @contracts_t721controller"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_t721controller/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_t721controller

            - name: "CACHE @contracts_t721token"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_t721token/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_t721token

            - name: "CACHE @contracts_ticketforge"
              uses: actions/cache@v1
              with:
                  path: ./modules/@contracts_ticketforge/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-@contracts_ticketforge

            #
            # Cache Public Modules
            #

            - name: "CACHE @public_dosojin"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_dosojin/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_dosojin/yarn.lock') }}-public_dosojin

            - name: "CACHE @public_e712"
              uses: actions/cache@v1
              with:
                  path: ./modules/@public_e712/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('modules/@public_e712/yarn.lock') }}-public_e712

            #
            # Cache Coverage Directory
            #

            - name: "CACHE @backend_nest/coverage-server-e2e"
              uses: actions/cache@v1
              with:
                  path: modules/@backend_nest/coverage-server-e2e
                  key: ${{ runner.os }}-backend_nest-coverage-server-e2e${{ github.sha }}

            #
            # Cache Yarn Workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @common_sdk"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_sdk/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_sdk

            - name: "CACHE @common_global"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_global/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_global

            - name: "CACHE @backend_nest"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_nest/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_nest
                  
            - name: "CACHE @backend_simulation"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_simulation/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_simulation

            #
            # Setup portals
            #

            - name: "Setup portals (yarn setup:portals)"
              run: yarn setup:portals

            #
            # Build dependencies
            #

            - name: "Build @common_global (yarn build in modules/@common_global)"
              working-directory: modules/@common_global
              run: yarn build

            - name: "Build @common_sdk (yarn build in modules/@common_sdk)"
              working-directory: modules/@common_sdk
              run: yarn build

            #
            # Run e2e tests
            #

            - name: "Run @backend_nest @app/server e2e tests (yarn test:server:e2e:cov in modules/@backend_nest)"
              run: sudo sysctl -w vm.max_map_count=262144 && cd modules/@backend_nest && yarn test:server:e2e:cov
              env:
                  DEPLOY: true

#     /$$$$  /$$$$$$   /$$$$$$  /$$$$
#    | $$_/ /$$__  $$ /$$__  $$|_  $$
#    | $$  | $$  \__/|__/  \ $$  | $$
#    | $$  |  $$$$$$   /$$$$$$/  | $$
#    | $$   \____  $$ /$$____/   | $$
#    | $$   /$$  \ $$| $$        | $$
#    | $$$$|  $$$$$$/| $$$$$$$$ /$$$$
#    |____/ \______/ |________/|____/
#
#    @frontend_flib-react - build, build-storybook, lint & format check
#
#    Recovers required dependencies from cache
#    Builds sources to verify everything still transpiles properly
#    Builds storybook to verify that components can be imported properly
#    Lints sources to verify everything is formatted properly
#    Runs prettier norm checker to verify everything is formatted properly
#

    flib-react:
        name: "[S2] [@frontend/flib-react] build, build-storybook & format check"
        needs: install
        runs-on: ubuntu-latest
        steps:

            #
            # Initial Setup
            #

            - uses: actions/checkout@v1
            - name: "Use Node.js 12.x"
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: "Install required tools globally (npm install -g yarn)"
              run: npm install -g yarn@1.22.4

            #
            # Cache Yarn Workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @frontend_flib-react"
              uses: actions/cache@v1
              with:
                  path: ./modules/@frontend_flib-react/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-frontend_flib-react

            #
            # Build & Build Storybook, Lint & Format check @frontend_flib-react
            #

            - name: "Build @frontend/flib-react (yarn build in modules/@frontend_flib-react)"
              working-directory: modules/@frontend_flib-react
              run: yarn build

            - name: "Build Storybook @frontend/flib-react (yarn build-storybook in modules/@frontend_flib-react)"
              working-directory: modules/@frontend_flib-react
              run: yarn build-storybook

            - name: "Lint @frontend/flib-react (yarn lint in modules/@frontend_flib-react)"
              working-directory: modules/@frontend_flib-react
              run: yarn lint

            - name: "Format check @frontend/flib-react (yarn format:check in modules/@frontend_flib-react)"
              working-directory: modules/@frontend_flib-react
              run: yarn format:check

#     /$$$$  /$$$$$$   /$$$$$$  /$$$$
#    | $$_/ /$$__  $$ /$$__  $$|_  $$
#    | $$  | $$  \__/|__/  \ $$  | $$
#    | $$  |  $$$$$$   /$$$$$$/  | $$
#    | $$   \____  $$ /$$____/   | $$
#    | $$   /$$  \ $$| $$        | $$
#    | $$$$|  $$$$$$/| $$$$$$$$ /$$$$
#    |____/ \______/ |________/|____/
#
#    @frontend_core - build, lint, format check & tests
#
#    Recovers required dependencies from cache
#    Builds sources to verify everything still transpiles properly
#    Lints sources to verify everything is formatted properly
#    Runs prettier norm checker to verify everything is formatted properly
#    Runs unitary tests to verify logic is kept
#

    frontend-core:
        name: "[S2] [@frontend/core] build, lint, format check & tests"
        needs: install
        runs-on: ubuntu-latest
        steps:

            #
            # Initial Setup
            #

            - uses: actions/checkout@v1
            - name: "Use Node.js 12.x"
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: "Install required tools globally (npm install -g yarn)"
              run: npm install -g yarn@1.22.4

            #
            # Cache Yarn Workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @common_global"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_global/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_global

            - name: "CACHE @common_sdk"
              uses: actions/cache@v1
              with:
                  path: ./modules/@common_sdk/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-common_sdk

            - name: "CACHE @frontend_flib-react"
              uses: actions/cache@v1
              with:
                  path: ./modules/@frontend_flib-react/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-frontend_flib-react

            - name: "CACHE @frontend_core"
              uses: actions/cache@v1
              with:
                  path: ./modules/@frontend_core/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-frontend_core

            - name: "CACHE @backend_nest"
              uses: actions/cache@v1
              with:
                  path: ./modules/@backend_nest/node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-backend_nest


          #
          # Build dependencies
          #

            - name: "Build @common_global (yarn build in modules/@common_global)"
              working-directory: modules/@common_global
              run: yarn build

            - name: "Build @common_sdk (yarn build in modules/@common_sdk)"
              working-directory: modules/@common_sdk
              run: yarn build

            - name: "Build @frontend_flib-react (yarn build in modules/@frontend_flib-react)"
              working-directory: modules/@frontend_flib-react
              run: yarn build

            #
            # Build, Lint, Format check & Tests @frontend_core
            #

            - name: "Build @frontend/core (yarn build in modules/@frontend_core)"
              working-directory: modules/@frontend_core
              run: yarn build

            - name: "Lint @frontend/core (yarn lint in modules/@frontend_core)"
              working-directory: modules/@frontend_core
              run: yarn lint

            - name: "Format check @frontend/core (yarn format:check in modules/@frontend_core)"
              working-directory: modules/@frontend_core
              run: yarn format:check

            - name: "Tests @frontend/core (yarn test in modules/@frontend_core)"
              working-directory: modules/@frontend_core
              run: yarn test

#     /$$$$  /$$$$$$   /$$$$$$  /$$$$
#    | $$_/ /$$__  $$ /$$__  $$|_  $$
#    | $$  | $$  \__/|__/  \ $$  | $$
#    | $$  |  $$$$$$    /$$$$$/  | $$
#    | $$   \____  $$  |___  $$  | $$
#    | $$   /$$  \ $$ /$$  \ $$  | $$
#    | $$$$|  $$$$$$/|  $$$$$$/ /$$$$
#    |____/ \______/  \______/ |____/
#
#    @repo - upload coverage data
#
#    Recovers required dependencies from cache
#    Uploads coverage artifacts to codecov
#

    coverage:
        name: "[S3] [@repo] upload coverage data"
        needs: [global, sdk, server, server-e2e]
        runs-on: ubuntu-latest
        steps:

            #
            # Initial Setup
            #

            - uses: actions/checkout@v1
            - name: "Use Node.js 12.x"
              uses: actions/setup-node@v1.2.0
              with:
                  node-version: 12.x

            - name: "Install required tools globally (npm install -g yarn)"
              run: npm install -g yarn@1.22.4

            #
            # Cache yarn workspaces
            #

            - name: "CACHE root"
              uses: actions/cache@v1
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}-root

            - name: "CACHE @backend_nest/coverage-server-e2e"
              uses: actions/cache@v1
              with:
                  path: modules/@backend_nest/coverage-server-e2e
                  key: ${{ runner.os }}-backend_nest-coverage-server-e2e${{ github.sha }}

            - name: "CACHE @backend_nest/coverage"
              uses: actions/cache@v1
              with:
                  path: modules/@backend_nest/coverage
                  key: ${{ runner.os }}-backend_nest-coverage-${{ github.sha }}

            - name: "CACHE @common/global/coverage"
              uses: actions/cache@v1
              with:
                  path: modules/@common_global/coverage
                  key: ${{ runner.os }}-common_global-coverage-${{ github.sha }}

            #
            # Run coverage upload script
            #

            - name: "Codecov (yarn codecov:upload)"
              run: yarn codecov:upload
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    infra-dry-run:
      name: "[S3] infra (staging) dry run"
      needs: [global, sdk, server, server-e2e]
      runs-on: ubuntu-latest
      steps:

        #
        # Initial Setup
        #

        - uses: actions/checkout@v1
        - name: "Use Node.js 12.x"
          uses: actions/setup-node@v1.2.0
          with:
            node-version: 12.x

        - name: "Setup SSH Agent"
          uses: webfactory/ssh-agent@v0.1.1
          with:
            ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

        - name: "Install required tools globally (npm install -g lerna lcov-result-merger yarn)"
          run: npm install -g lerna@3.16.4 lcov-result-merger@3.1.0 yarn@1.22.4

        - name: "Recover submodules (yarn setup:submodules:clone)"
          run: yarn setup:submodules:clone

        - name: "Setup aws CLI"
          uses: chrislennon/action-aws-cli@v1.1

        - name: "Setup kubectl"
          run: curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv ./kubectl /usr/local/bin/kubectl

        - name: "Setup kubeconfig"
          run: aws eks update-kubeconfig --name ${CONFIG_STAGING_CLUSTER_NAME}
          env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_USER_ID: ${{ secrets.AWS_USER_ID }}
            AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
            CONFIG_STAGING_CLUSTER_NAME: ${{ secrets.CONFIG_STAGING_CLUSTER_NAME }}

        - name: "Setup Helm + Helm Diff"
          run: curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash && helm plugin install https://github.com/databus23/helm-diff --version master

        - name: "Setup Helmsman"
          run: curl -L https://github.com/Praqma/helmsman/releases/download/v3.4.2/helmsman_3.4.2_linux_amd64.tar.gz | tar zx && chmod +x helmsman && sudo mv ./helmsman /usr/local/bin/helmsman

        - name: "Fetch Helm Repos and Dependencies"
          run: ./helm_prepare.sh

        - name: "Helmsman on staging infra (dry-run)"
          run: ./helmsman.dryrun.staging.sh
          env:
            CONFIG_STAGING_STRIPE_APIKEY: ${{ secrets.CONFIG_STAGING_STRIPE_APIKEY }}
            CONFIG_STAGING_ROCKSIDE_APIKEY: ${{ secrets.CONFIG_STAGING_ROCKSIDE_APIKEY }}
            CONFIG_STAGING_MAILJET_APIKEY: ${{ secrets.CONFIG_STAGING_MAILJET_APIKEY }}
            CONFIG_STAGING_MAILJET_APISECRET: ${{ secrets.CONFIG_STAGING_MAILJET_APISECRET }}
            CONFIG_STAGING_JWT_SECRET: ${{ secrets.CONFIG_STAGING_JWT_SECRET }}
            CONFIG_STAGING_ROUTE53_KEY: ${{ secrets.CONFIG_STAGING_ROUTE53_KEY }}
            CONFIG_STAGING_ROUTE53_SECRET: ${{ secrets.CONFIG_STAGING_ROUTE53_SECRET }}
            CONFIG_STAGING_ROUTE53_HOSTEDZONE: ${{ secrets.CONFIG_STAGING_ROUTE53_HOSTEDZONE }}
            CONFIG_STAGING_ACME_SERVER: ${{ secrets.CONFIG_STAGING_ACME_SERVER }}

            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_USER_ID: ${{ secrets.AWS_USER_ID }}
            AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

    docker:
      name: "[S3] docker"
      needs: [global, sdk, server, server-e2e]
      if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
      runs-on: ubuntu-latest
      steps:

        #
        # Initial Setup
        #

        - uses: actions/checkout@v1
        - name: "Use Node.js 12.x"
          uses: actions/setup-node@v1.2.0
          with:
            node-version: 12.x

        - name: "Setup SSH Agent"
          uses: webfactory/ssh-agent@v0.1.1
          with:
            ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

        - name: "Install required tools globally (npm install -g lerna lcov-result-merger yarn)"
          run: npm install -g lerna@3.16.4 lcov-result-merger@3.1.0 yarn@1.22.4

        - name: "Recover submodules (yarn setup:submodules:clone)"
          run: yarn setup:submodules:clone

        - name: "Setup aws CLI"
          uses: chrislennon/action-aws-cli@v1.1

        - name: "Authenticate Docker"
          run: ./aws-ecr-login.sh
          env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_USER_ID: ${{ secrets.AWS_USER_ID }}
            AWS_REGION: ${{ secrets.AWS_REGION }}

        - name: "Build all docker images"
          run: yarn @docker:build:github

        - name: "Publish to Elastic Container Registry"
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            AWS_USER_ID: ${{ secrets.AWS_USER_ID }}
            AWS_REGION: ${{ secrets.AWS_REGION }}
          run: yarn @docker:deploy:github

    infra:
      name: "[S4] infra (staging)"
      if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
      needs: docker
      runs-on: ubuntu-latest
      steps:

        #
        # Initial Setup
        #

        - uses: actions/checkout@v1
        - name: "Use Node.js 12.x"
          uses: actions/setup-node@v1.2.0
          with:
            node-version: 12.x

        - name: "Setup SSH Agent"
          uses: webfactory/ssh-agent@v0.1.1
          with:
            ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

        - name: "Install required tools globally (npm install -g lerna lcov-result-merger yarn)"
          run: npm install -g lerna@3.16.4 lcov-result-merger@3.1.0 yarn@1.22.4

        - name: "Recover submodules (yarn setup:submodules:clone)"
          run: yarn setup:submodules:clone

        - name: "Setup aws CLI"
          uses: chrislennon/action-aws-cli@v1.1

        - name: "Setup kubectl"
          run: curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv ./kubectl /usr/local/bin/kubectl

        - name: "Setup kubeconfig"
          run: aws eks update-kubeconfig --name ${CONFIG_STAGING_CLUSTER_NAME}
          env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_USER_ID: ${{ secrets.AWS_USER_ID }}
            AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
            CONFIG_STAGING_CLUSTER_NAME: ${{ secrets.CONFIG_STAGING_CLUSTER_NAME }}

        - name: "Setup Helm + Helm Diff"
          run: curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash && helm plugin install https://github.com/databus23/helm-diff --version master

        - name: "Setup Helmsman"
          run: curl -L https://github.com/Praqma/helmsman/releases/download/v3.4.2/helmsman_3.4.2_linux_amd64.tar.gz | tar zx && chmod +x helmsman && sudo mv ./helmsman /usr/local/bin/helmsman

        - name: "Fetch Helm Repos and Dependencies"
          run: ./helm_prepare.sh

        - name: "Helmsman on staging infra"
          run: ./helmsman.apply.staging.sh
          env:
            CONFIG_STAGING_STRIPE_APIKEY: ${{ secrets.CONFIG_STAGING_STRIPE_APIKEY }}
            CONFIG_STAGING_ROCKSIDE_APIKEY: ${{ secrets.CONFIG_STAGING_ROCKSIDE_APIKEY }}
            CONFIG_STAGING_MAILJET_APIKEY: ${{ secrets.CONFIG_STAGING_MAILJET_APIKEY }}
            CONFIG_STAGING_MAILJET_APISECRET: ${{ secrets.CONFIG_STAGING_MAILJET_APISECRET }}
            CONFIG_STAGING_JWT_SECRET: ${{ secrets.CONFIG_STAGING_JWT_SECRET }}
            CONFIG_STAGING_ROUTE53_KEY: ${{ secrets.CONFIG_STAGING_ROUTE53_KEY }}
            CONFIG_STAGING_ROUTE53_SECRET: ${{ secrets.CONFIG_STAGING_ROUTE53_SECRET }}
            CONFIG_STAGING_ROUTE53_HOSTEDZONE: ${{ secrets.CONFIG_STAGING_ROUTE53_HOSTEDZONE }}
            CONFIG_STAGING_ACME_SERVER: ${{ secrets.CONFIG_STAGING_ACME_SERVER }}

            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_USER_ID: ${{ secrets.AWS_USER_ID }}
            AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

